{# app/templates/products/index.html #}
{% extends "base.html" %}

{% block content %}
<style>
    .panel-min-height {
        min-height: 50vh; /* 調整為視窗高度的 50% */
    }
    .recipe-search-result-item.active {
        background-color: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
        color: white !important;
    }
    .table .text-end {
        text-align: right;
    }
    /* 為表單標題添加統一的下劃線 */
    .form-section-title {
        border-bottom: 2px solid var(--bs-primary-light); /* 更粗一點的底線 */
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-weight: bold; /* 加粗 */
        color: var(--bs-primary); /* 標題顏色 */
        font-size: 1.5rem; /* 稍微大一點 */
    }
    /* 將驗證錯誤訊息調整為更明顯 */
    .form-control.is-invalid {
        border-color: var(--bs-danger) !important;
    }
    .invalid-feedback {
        display: block; /* 確保顯示 */
        color: var(--bs-danger) !important;
    }
    /* 載入動畫 */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: .15em;
    }
</style>

<div class="container">
    <h1 class="mb-4">{{ title }}</h1>

    {# 閃現訊息已在 base.html 中處理 #}

    <div class="row g-4 mb-4">
        <div id="left-panel" class="col-lg-4 p-3 border rounded shadow-sm panel-min-height">
            <h3 class="mb-3 text-primary">建立新產品</h3>
            <p class="text-muted"><strong>選擇食譜作為基礎：</strong></p>
            <input type="search" id="recipe-search-box" class="form-control mb-3" placeholder="搜尋食譜名稱...">
            <div id="recipe-search-results" class="list-group" style="max-height: calc(50vh - 120px); overflow-y: auto;">
                <p class="text-muted p-2 text-center">載入食譜中...</p>
            </div>
            <hr class="my-3">
            <div id="selected-recipe-info" class="mt-3 p-3 border rounded bg-light" style="display: none;">
                <h5 class="text-primary mb-2">已選擇食譜: <strong id="selected-recipe-name"></strong></h5>
                <p class="mb-1">食譜份數: <span class="badge bg-info text-dark fs-6" id="selected-recipe-servings"></span> 份</p>
                <p class="mb-1">食譜總重量: <span class="badge bg-light text-dark fs-6" id="selected-recipe-total-weight"></span> 克</p>
                <p class="mb-3">食譜食材總成本: <span class="badge bg-light text-dark fs-6" id="selected-recipe-total-ingredient-cost"></span></p>
                <button id="start-create-product-btn" class="btn btn-primary w-100">
                    <i class="bi bi-box-seam me-2"></i>建立此產品
                </button>
            </div>
        </div>

        <div id="center-panel" class="col-lg-8 p-3 border rounded shadow-sm panel-min-height">
            <h3 class="mb-3">產品資料與成本計算</h3>
            <div id="product-create-form-section" style="display: none;">
                <h4 class="form-section-title">產品基本資訊</h4>
                <div class="mb-3">
                    {{ form.product_name.label(class="form-label") }}
                    {{ form.product_name(class="form-control") }}
                    <div class="invalid-feedback" id="error-product_name"></div>
                </div>
                <div class="mb-3">
                    {{ form.description.label(class="form-label") }}
                    {{ form.description(class="form-control", rows=3) }}
                    <div class="invalid-feedback" id="error-description"></div>
                </div>
                
                <h4 class="form-section-title">生產參數</h4>
                <div class="mb-3">
                    {{ form.batch_size.label(class="form-label") }}
                    {{ form.batch_size(class="form-control", min=1) }}
                    <div class="invalid-feedback" id="error-batch_size"></div>
                </div>
                <div class="mb-3">
                    {{ form.bake_power_w.label(class="form-label") }}
                    {{ form.bake_power_w(class="form-control", min=0, step="0.01") }}
                    <div class="invalid-feedback" id="error-bake_power_w"></div>
                </div>
                <div class="mb-3">
                    {{ form.bake_time_min.label(class="form-label") }}
                    {{ form.bake_time_min(class="form-control", min=0, step="0.01") }}
                    <div class="invalid-feedback" id="error-bake_time_min"></div>
                </div>
                <div class="mb-3">
                    {{ form.production_time_hr.label(class="form-label") }}
                    {{ form.production_time_hr(class="form-control", min=0, step="0.01") }}
                    <div class="invalid-feedback" id="error-production_time_hr"></div>
                </div>

                <h4 class="form-section-title">食材成本細項</h4>
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover table-bordered cost-table">
                        <thead>
                            <tr>
                                <th>食材名稱</th>
                                <th class="text-end">用量 (克)</th>
                                <th class="text-end">每克成本 (NT$)</th>
                                <th>來源</th>
                                <th class="text-end">總計 (NT$)</th>
                            </tr>
                        </thead>
                        <tbody id="ingredient-cost-details-tbody">
                            <tr><td colspan="5" class="text-muted text-center">請選擇食譜以載入食材成本細項。</td></tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="4" class="text-end">食譜食材總成本:</th>
                                <th id="total-ingredient-cost-display" class="text-end">NT$ 0.00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <h4 class="form-section-title">總成本預覽 (每批次)</h4>
                <div id="cost-preview-section" class="p-3 bg-light rounded shadow-sm">
                    <p class="mb-1">每個產品食材成本: <strong id="per-product-ingredient-cost">NT$ 0.00</strong></p>
                    <p class="mb-1">批次食材總成本: <strong id="batch-ingredient-total-cost">NT$ 0.00</strong></p>
                    <p class="mb-1">電費成本 (費率 {{ electricity_cost_per_kwh }} NT$/kWh): <strong id="electricity-cost">NT$ 0.00</strong></p>
                    <p class="mb-1">人力成本 (費率 {{ labor_cost_per_hour }} NT$/hr): <strong id="labor-cost">NT$ 0.00</strong></p>
                    <p class="mb-1">批次總成本: <strong id="total-batch-cost">NT$ 0.00</strong></p>
                    <p class="fs-5 text-success mt-3">平均每個產品總成本: <strong id="avg-cost-per-product">NT$ 0.00</strong></p>
                </div>

                <h4 class="form-section-title">產品定價與庫存</h4>
                <div class="mb-3">
                    {{ form.selling_price.label(class="form-label") }}
                    {{ form.selling_price(class="form-control", min=0, step="0.01") }}
                    <div class="invalid-feedback" id="error-selling_price"></div>
                </div>
                <div class="mb-3">
                    {{ form.stock_quantity.label(class="form-label") }}
                    {{ form.stock_quantity(class="form-control", min=0) }}
                    <div class="invalid-feedback" id="error-stock_quantity"></div>
                </div>

                <button type="button" id="submit-product-btn" class="btn btn-success btn-lg w-100">
                    <span id="submit-button-text"><i class="bi bi-save me-2"></i>儲存產品</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="submit-spinner"></span>
                </button>
            </div>
            <p id="no-recipe-selected-message" class="alert alert-info mt-3 text-center p-4 rounded shadow-sm">
                <i class="bi bi-lightbulb me-2"></i>請從左側選擇一個食譜來建立產品。
            </p>
        </div>
    </div>
    <hr class="my-4">
    <h3 class="mb-3">現有產品列表</h3>
    {% if products %}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered mt-3 shadow-sm">
                <thead>
                    <tr>
                        <th>產品名稱</th>
                        <th>關聯食譜</th>
                        <th class="text-end">成本 (NT$)</th>
                        <th class="text-end">售價 (NT$)</th>
                        <th class="text-end">毛利率 (%)</th>
                        <th class="text-end">庫存</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.product_name }}</td>
                        <td><a href="{{ url_for('recipes.recipe_detail', recipe_id=product.recipe.id) }}" class="text-decoration-none">{{ product.recipe.recipe_name }}</a></td>
                        <td class="text-end">{{ product.calculated_cost | round(2) }}</td>
                        <td class="text-end">{{ product.selling_price | round(2) }}</td>
                        <td class="text-end">{{ product.calculate_profit_margin() | round(2) }}%</td>
                        <td class="text-end">{{ product.stock_quantity }}</td>
                        <td>
                            <a href="{{ url_for('products.edit_product', product_id=product.id) }}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="bi bi-pencil me-1"></i>編輯
                            </a>
                            <form action="{{ url_for('products.delete_product', product_id=product.id) }}" method="post" onsubmit="return confirm('確定要刪除產品 {{ product.product_name }} 嗎？');" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash me-1"></i>刪除
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-secondary mt-4 text-center p-4 rounded shadow-sm">
            <p class="mb-0">您目前還沒有建立任何產品。</p>
            <p class="mb-0">請從左側面板選擇一個食譜來建立您的第一個產品吧！</p>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const recipeSearchBox = document.getElementById('recipe-search-box');
    const recipeSearchResultsDiv = document.getElementById('recipe-search-results');
    const selectedRecipeInfoDiv = document.getElementById('selected-recipe-info');
    const startCreateProductBtn = document.getElementById('start-create-product-btn');
    const productCreateFormSection = document.getElementById('product-create-form-section');
    const noRecipeSelectedMessage = document.getElementById('no-recipe-selected-message');
    const ingredientCostDetailsTbody = document.getElementById('ingredient-cost-details-tbody');
    const totalIngredientCostDisplay = document.getElementById('total-ingredient-cost-display');

    // 產品表單元素
    const productNameInput = document.getElementById('product_name');
    const descriptionInput = document.getElementById('description');
    const sellingPriceInput = document.getElementById('selling_price');
    const stockQuantityInput = document.getElementById('stock_quantity');
    const batchSizeInput = document.getElementById('batch_size');
    const bakePowerWInput = document.getElementById('bake_power_w');
    const bakeTimeMinInput = document.getElementById('bake_time_min');
    const productionTimeHrInput = document.getElementById('production_time_hr');
    const submitProductBtn = document.getElementById('submit-product-btn');
    const submitButtonText = document.getElementById('submit-button-text');
    const submitSpinner = document.getElementById('submit-spinner');


    // 成本預覽元素
    const perProductIngredientCostElem = document.getElementById('per-product-ingredient-cost');
    const batchIngredientTotalCostElem = document.getElementById('batch-ingredient-total-cost');
    const electricityCostElem = document.getElementById('electricity-cost');
    const laborCostElem = document.getElementById('labor-cost');
    const totalBatchCostElem = document.getElementById('total-batch-cost');
    const avgCostPerProductElem = document.getElementById('avg-cost-per-product');

    let selectedRecipeId = null;
    let selectedRecipeData = null; // 儲存從 API 獲取的完整食譜數據
    
    // 從 Flask 模板獲取固定費率
    const electricityCostPerKwh = {{ electricity_cost_per_kwh | tojson }};
    const laborCostPerHour = {{ labor_cost_per_hour | tojson }};

    function showLoadingState(isLoading) {
        if (isLoading) {
            submitProductBtn.disabled = true;
            submitButtonText.classList.add('d-none');
            submitSpinner.classList.remove('d-none');
        } else {
            submitProductBtn.disabled = false;
            submitButtonText.classList.remove('d-none');
            submitSpinner.classList.add('d-none');
        }
    }

    function displayErrors(errors) {
        // 清除所有舊的錯誤訊息
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

        // 顯示新的錯誤訊息
        for (const fieldName in errors) {
            const inputElement = document.getElementById(fieldName);
            if (inputElement) {
                inputElement.classList.add('is-invalid');
                const errorElement = document.getElementById(`error-${fieldName}`);
                if (errorElement) {
                    errorElement.textContent = errors[fieldName].join(', ');
                }
            }
        }
    }

    function calculateAndDisplayCosts() {
        const batchSize = parseFloat(batchSizeInput.value) || 1;
        const bakePowerW = parseFloat(bakePowerWInput.value) || 0;
        const bakeTimeMin = parseFloat(bakeTimeMinInput.value) || 0;
        const productionTimeHr = parseFloat(productionTimeHrInput.value) || 0;

        if (!selectedRecipeData) {
            perProductIngredientCostElem.textContent = 'NT$ 0.00';
            batchIngredientTotalCostElem.textContent = 'NT$ 0.00';
            electricityCostElem.textContent = 'NT$ 0.00';
            laborCostElem.textContent = 'NT$ 0.00';
            totalBatchCostElem.textContent = 'NT$ 0.00';
            avgCostPerProductElem.textContent = 'NT$ 0.00';
            return;
        }

        const recipeServingsCount = selectedRecipeData.servings_count || 1;
        const totalIngredientCostForRecipe = selectedRecipeData.total_ingredient_cost || 0;

        // 計算每個產品的食材成本
        const ingredientCostPerServing = totalIngredientCostForRecipe / recipeServingsCount;
        perProductIngredientCostElem.textContent = `NT$ ${ingredientCostPerServing.toFixed(2)}`;

        // 計算一個批次的食材總成本
        const batchIngredientTotalCost = ingredientCostPerServing * batchSize;
        batchIngredientTotalCostElem.textContent = `NT$ ${batchIngredientTotalCost.toFixed(2)}`;

        // 計算電費成本 (一個批次)
        let electricityCost = 0;
        if (bakePowerW > 0 && bakeTimeMin > 0) {
            const totalBakeTimeHr = bakeTimeMin / 60.0;
            const totalElectricityKwh = (bakePowerW * totalBakeTimeHr) / 1000.0;
            electricityCost = totalElectricityKwh * electricityCostPerKwh;
        }
        electricityCostElem.textContent = `NT$ ${electricityCost.toFixed(2)}`;

        // 計算人力成本 (一個批次)
        const laborCost = productionTimeHr * laborCostPerHour;
        laborCostElem.textContent = `NT$ ${laborCost.toFixed(2)}`;

        // 計算一個批次的總成本 (食材 + 電費 + 人力)
        const totalBatchCost = batchIngredientTotalCost + electricityCost + laborCost;
        totalBatchCostElem.textContent = `NT$ ${totalBatchCost.toFixed(2)}`;

        // 計算平均每個產品的總成本
        const avgCostPerProduct = batchSize > 0 ? totalBatchCost / batchSize : 0;
        avgCostPerProductElem.textContent = `NT$ ${avgCostPerProduct.toFixed(2)}`;
    }

    // 監聽生產參數的變化以更新成本預覽
    batchSizeInput.addEventListener('input', calculateAndDisplayCosts);
    bakePowerWInput.addEventListener('input', calculateAndDisplayCosts);
    bakeTimeMinInput.addEventListener('input', calculateAndDisplayCosts);
    productionTimeHrInput.addEventListener('input', calculateAndDisplayCosts);

    function renderRecipeSearchResults(recipes) {
        console.log("Rendering search results. Received recipes:", recipes);
        recipeSearchResultsDiv.innerHTML = ''; // 清空之前的搜尋結果
        if (recipes.length > 0) {
            recipes.forEach(recipe => {
                const resultItem = document.createElement('div');
                resultItem.className = 'recipe-search-result-item list-group-item list-group-item-action py-2';
                resultItem.innerHTML = `
                    <h6 class="mb-0 text-primary">${recipe.name}</h6>
                    <small class="text-muted">份數: ${recipe.servings_count}, 成本: NT$ ${recipe.total_ingredient_cost.toFixed(2)}</small>
                `;
                resultItem.setAttribute('data-recipe-id', recipe.id);
                resultItem.addEventListener('click', () => selectRecipe(recipe.id));
                recipeSearchResultsDiv.appendChild(resultItem);
            });
        } else {
            recipeSearchResultsDiv.innerHTML = '<p class="text-muted p-2 text-center">沒有找到符合條件的食譜。</p>';
        }
    }


    function searchRecipes() {
        const query = recipeSearchBox.value.trim();
        // 只有在查詢字串長度足夠或查詢為空時才發送請求 (初始載入時顯示所有)
        if (query.length < 2 && query !== "") {
            recipeSearchResultsDiv.innerHTML = '<p class="text-muted p-2 text-center">輸入至少2個字搜尋您的食譜。</p>';
            selectedRecipeInfoDiv.style.display = 'none';
            productCreateFormSection.style.display = 'none';
            noRecipeSelectedMessage.style.display = 'block';
            selectedRecipeId = null;
            selectedRecipeData = null;
            calculateAndDisplayCosts();
            return;
        }

        // 如果搜尋框為空，則直接渲染初始食譜數據，不發送 API 請求
        if (query === "") {
            console.log("Search query is empty, rendering initial recipes.");
            renderRecipeSearchResults(initialRecipes); // 直接使用初始數據
            selectedRecipeInfoDiv.style.display = 'none';
            productCreateFormSection.style.display = 'none';
            noRecipeSelectedMessage.style.display = 'block';
            selectedRecipeId = null;
            selectedRecipeData = null;
            calculateAndDisplayCosts();
            return;
        }

        fetch(`/products/api/search_recipes?q=${query}`)
            .then(response => response.json())
            .then(data => {
                renderRecipeSearchResults(data);
            })
            .catch(error => {
                console.error('Error searching recipes:', error);
                recipeSearchResultsDiv.innerHTML = '<p class="text-danger p-2 text-center">搜尋食譜時發生錯誤。</p>';
            });
    }

    function selectRecipe(recipeId) {
        selectedRecipeId = recipeId;
        // 清除所有選中狀態
        document.querySelectorAll('.recipe-search-result-item').forEach(item => {
            item.classList.remove('active');
        });
        // 標記選中的食譜
        document.querySelector(`.recipe-search-result-item[data-recipe-id="${recipeId}"]`).classList.add('active');

        // 獲取選中食譜的詳細資訊
        fetch(`/products/api/get_recipe_details/${recipeId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    selectedRecipeData = data;
                    document.getElementById('selected-recipe-name').textContent = data.recipe_name;
                    document.getElementById('selected-recipe-servings').textContent = data.servings_count;
                    document.getElementById('selected-recipe-total-weight').textContent = data.total_weight_g.toFixed(1);
                    document.getElementById('selected-recipe-total-ingredient-cost').textContent = `NT$ ${data.total_ingredient_cost.toFixed(2)}`;
                    
                    // 填充食材成本細項表格
                    ingredientCostDetailsTbody.innerHTML = '';
                    if (data.ingredient_cost_details && data.ingredient_cost_details.length > 0) {
                        data.ingredient_cost_details.forEach(item => {
                            const row = `
                                <tr>
                                    <td>${item.ingredient_name}</td>
                                    <td class="text-end">${item.quantity_g.toFixed(1)}</td>
                                    <td class="text-end">${item.cost_per_gram.toFixed(4)}</td>
                                    <td>${item.cost_source || '無'}</td>
                                    <td class="text-end">${item.item_total_cost.toFixed(2)}</td>
                                </tr>
                            `;
                            ingredientCostDetailsTbody.innerHTML += row;
                        });
                    } else {
                        ingredientCostDetailsTbody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">此食譜沒有食材細項。</td></tr>';
                    }
                    totalIngredientCostDisplay.textContent = `NT$ ${data.total_ingredient_cost.toFixed(2)}`;


                    selectedRecipeInfoDiv.style.display = 'block';
                    productNameInput.value = data.recipe_name + ' (產品)';
                    batchSizeInput.value = data.servings_count;

                    calculateAndDisplayCosts();
                } else {
                    alert('獲取食譜詳情失敗: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching recipe details:', error);
                alert('獲取食譜詳情時發生錯誤。');
            });
    }

    startCreateProductBtn.addEventListener('click', function() {
        if (selectedRecipeId) {
            noRecipeSelectedMessage.style.display = 'none';
            productCreateFormSection.style.display = 'block';
            productCreateFormSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('請先從左側選擇一個食譜！');
        }
    });

    submitProductBtn.addEventListener('click', function() {
        if (!selectedRecipeId) {
            alert('請先選擇一個食譜來建立產品！');
            return;
        }

        const formData = {
            recipe_id: selectedRecipeId,
            product_name: productNameInput.value,
            description: descriptionInput.value,
            selling_price: sellingPriceInput.value,
            stock_quantity: stockQuantityInput.value,
            batch_size: batchSizeInput.value,
            bake_power_w: bakePowerWInput.value,
            bake_time_min: bakeTimeMinInput.value,
            production_time_hr: productionTimeHrInput.value
        };

        showLoadingState(true); // 顯示載入狀態
        displayErrors({}); // 清除所有錯誤

        fetch('/products/api/create_product', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            showLoadingState(false); // 隱藏載入狀態
            if (data.status === 'success') {
                alert(data.message);
                window.location.reload();
            } else {
                alert('建立產品失敗: ' + data.message);
                if (data.errors) {
                    displayErrors(data.errors);
                }
            }
        })
        .catch(error => {
            showLoadingState(false); // 隱藏載入狀態
            console.error('Error submitting product:', error);
            alert('提交產品時發生錯誤。');
        });
    });

    let searchTimeout;
    recipeSearchBox.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        if (this.value.trim() === "") {
            searchRecipes();
        } else {
            searchTimeout = setTimeout(searchRecipes, 300);
        }
    });

    const initialRecipes = {{ all_recipes_initial_data | tojson }};
    console.log("Initial Recipes Data:", initialRecipes);
    renderRecipeSearchResults(initialRecipes);

});
</script>
{% endblock %}