{# app/templates/recipes/manage_ingredients.html #}

{% extends "base.html" %}

{% block content %}
<style>
    .panel-min-height {
        min-height: 70vh; /* 調整為視窗高度的 70% */
    }
    .list-group-item.active {
        background-color: var(--bs-primary) !important;
        border-color: var(--bs-primary) !important;
        color: white !important;
    }
    /* 為表單中的 label 和 input 調整對齊，使其在同一行 */
    .form-row-compact .col-form-label {
        padding-top: calc(0.375rem + 1px);
        padding-bottom: calc(0.375rem + 1px);
        margin-bottom: 0;
        text-align: right;
        padding-right: 1rem;
    }
    /* 載入動畫 */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: .15em;
    }
</style>

<div class="container">
    <h1 class="mb-4">食材管理</h1>

    <div class="d-flex flex-column flex-lg-row gap-4">
        <div id="left-panel" class="col-lg-4 p-3 border rounded shadow-sm panel-min-height">
            <h3 class="mb-3 text-primary">我的自訂食材</h3>
            <input type="search" id="ingredient-search-box" class="form-control mb-3" placeholder="搜尋您的食材...">
            <div id="search-results" class="list-group" style="max-height: calc(70vh - 150px); overflow-y: auto;">
                <p class="text-muted p-2 text-center">請輸入關鍵字搜尋。</p>
            </div>
        </div>

        <div id="center-panel" class="col-lg-5 p-3 border rounded shadow-sm panel-min-height">
            <h3 id="form-title" class="mb-3 text-primary">編輯食材資料</h3>
            <form id="ingredient-form" novalidate onsubmit="return false;">
                <p class="alert alert-info text-center"><i>請從左側列表選擇一個食材來編輯，或點擊右側的「新增」按鈕。</i></p>
            </form>
        </div>

        <div id="right-panel" class="col-lg-3 p-3 border rounded shadow-sm panel-min-height d-flex flex-column">
            <h3 class="mb-3 text-primary">操作</h3>
            <button id="new-btn" class="btn btn-success mb-2">
                <i class="bi bi-plus-lg me-2"></i>新增食材
            </button>
            <button id="save-btn" class="btn btn-primary mb-2" disabled>
                <span id="save-button-text"><i class="bi bi-save me-2"></i>儲存修改</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="save-spinner"></span>
            </button>
            <button id="delete-btn" class="btn btn-danger mb-2" disabled>
                <span id="delete-button-text"><i class="bi bi-trash me-2"></i>刪除食材</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="delete-spinner"></span>
            </button>
            <button id="cancel-btn" class="btn btn-secondary mb-2" disabled>
                <i class="bi bi-x-lg me-2"></i>取消操作
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formTemplate = `
        <div class="row mb-3 form-row-compact">
            <label for="food_name" class="col-sm-4 col-form-label">食材名稱:</label>
            <div class="col-sm-8">
                <input type="text" id="food_name" name="food_name" class="form-control" required>
                <div class="invalid-feedback" id="error-food_name"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="cost_per_unit" class="col-sm-4 col-form-label">成本 (每100g):</label>
            <div class="col-sm-8">
                <input type="number" id="cost_per_unit" name="cost_per_unit" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-cost_per_unit"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="unit_name" class="col-sm-4 col-form-label">單位名稱:</label>
            <div class="col-sm-8">
                <input type="text" id="unit_name" name="unit_name" class="form-control" value="g" required>
                <div class="invalid-feedback" id="error-unit_name"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="calories_kcal" class="col-sm-4 col-form-label">熱量 (大卡/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="calories_kcal" name="calories_kcal" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-calories_kcal"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="protein_g" class="col-sm-4 col-form-label">蛋白質 (克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="protein_g" name="protein_g" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-protein_g"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="fat_g" class="col-sm-4 col-form-label">總脂肪 (克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="fat_g" name="fat_g" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-fat_g"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="saturated_fat_g" class="col-sm-4 col-form-label">飽和脂肪 (克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="saturated_fat_g" name="saturated_fat_g" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-saturated_fat_g"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="trans_fat_g" class="col-sm-4 col-form-label">反式脂肪 (克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="trans_fat_g" name="trans_fat_g" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-trans_fat_g"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="carbohydrate_g" class="col-sm-4 col-form-label">總碳水化合物 (克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="carbohydrate_g" name="carbohydrate_g" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-carbohydrate_g"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="sugar_g" class="col-sm-4 col-form-label">糖 (克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="sugar_g" name="sugar_g" class="form-control" value="0" required min="0" step="0.01">
                <div class="invalid-feedback" id="error-sugar_g"></div>
            </div>
        </div>
        <div class="row mb-3 form-row-compact">
            <label for="sodium_mg" class="col-sm-4 col-form-label">鈉 (毫克/100g):</label>
            <div class="col-sm-8">
                <input type="number" id="sodium_mg" name="sodium_mg" class="form-control" value="0" required min="0" step="0.1">
                <div class="invalid-feedback" id="error-sodium_mg"></div>
            </div>
        </div>
    `;

    const searchBox = document.getElementById('ingredient-search-box');
    const searchResultsDiv = document.getElementById('search-results');
    const formContainer = document.getElementById('ingredient-form');
    const formTitle = document.getElementById('form-title');
    const newButton = document.getElementById('new-btn');
    const saveButton = document.getElementById('save-btn');
    const deleteButton = document.getElementById('delete-btn');
    const cancelButton = document.getElementById('cancel-btn');
    
    const saveButtonText = document.getElementById('save-button-text');
    const saveSpinner = document.getElementById('save-spinner');
    const deleteButtonText = document.getElementById('delete-button-text');
    const deleteSpinner = document.getElementById('delete-spinner');

    let currentIngredientId = null;

    function showLoadingState(buttonId, isLoading) {
        const button = document.getElementById(buttonId);
        const textSpan = button.querySelector('span:not(.spinner-border)');
        const spinner = button.querySelector('.spinner-border');

        if (isLoading) {
            button.disabled = true;
            if (textSpan) textSpan.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');
        } else {
            button.disabled = false;
            if (textSpan) textSpan.classList.remove('d-none');
            if (spinner) spinner.classList.add('d-none');
        }
    }

    function displayFormErrors(errors) {
        // 清除所有舊的錯誤訊息和無效狀態
        document.querySelectorAll('.form-control.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

        // 顯示新的錯誤訊息
        for (const fieldName in errors) {
            const inputElement = document.getElementById(fieldName);
            if (inputElement) {
                inputElement.classList.add('is-invalid');
                const errorElement = document.getElementById(`error-${fieldName}`);
                if (errorElement) {
                    errorElement.textContent = errors[fieldName].join(', ');
                }
            }
        }
    }

    function setupFormEventListeners() {
        const inputs = formContainer.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                if (this.value === '0') {
                    this.value = '';
                }
            });
            input.addEventListener('blur', function() {
                if (this.value === '') {
                    this.value = '0';
                }
            });
        });

        // 實時清除錯誤
        formContainer.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    this.classList.remove('is-invalid');
                    const errorElement = document.getElementById(`error-${this.id}`);
                    if (errorElement) {
                        errorElement.textContent = '';
                    }
                }
            });
        });
    }

    function getFormData() {
        return {
            food_name: document.getElementById('food_name').value,
            cost_per_unit: document.getElementById('cost_per_unit').value,
            unit_name: document.getElementById('unit_name').value,
            calories_kcal: document.getElementById('calories_kcal').value,
            protein_g: document.getElementById('protein_g').value,
            fat_g: document.getElementById('fat_g').value,
            saturated_fat_g: document.getElementById('saturated_fat_g').value,
            trans_fat_g: document.getElementById('trans_fat_g').value,
            carbohydrate_g: document.getElementById('carbohydrate_g').value,
            sugar_g: document.getElementById('sugar_g').value,
            sodium_mg: document.getElementById('sodium_mg').value,
        };
    }

    function performSearch() {
        const query = searchBox.value;
        fetch(`/recipes/api/search_ingredients?q=${query}&source=USER`)
            .then(response => response.json())
            .then(data => {
                searchResultsDiv.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(ingredient => {
                        const itemDiv = document.createElement('div');
                        itemDiv.textContent = ingredient.name;
                        itemDiv.className = 'list-group-item list-group-item-action';
                        itemDiv.setAttribute('data-id', ingredient.id);
                        if (ingredient.id == currentIngredientId) { itemDiv.classList.add('active'); }
                        itemDiv.addEventListener('click', () => selectIngredient(ingredient.id));
                        searchResultsDiv.appendChild(itemDiv);
                    });
                } else {
                    searchResultsDiv.innerHTML = '<p class="text-muted p-2 text-center">沒有找到符合條件的食材。</p>';
                }
            })
            .catch(error => {
                console.error('Error searching ingredients:', error);
                searchResultsDiv.innerHTML = '<p class="text-danger p-2 text-center">搜尋食材時發生錯誤。</p>';
            });
    }

    function selectIngredient(ingredientId) {
        fetch(`/recipes/api/ingredient/${ingredientId}`)
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    formContainer.innerHTML = formTemplate;
                    const data = result.data;
                    currentIngredientId = data.id;
                    formTitle.textContent = `編輯: ${data.food_name}`;
                    
                    // 填充表單值
                    document.getElementById('food_name').value = data.food_name;
                    document.getElementById('cost_per_unit').value = data.cost_per_unit;
                    document.getElementById('unit_name').value = data.unit_name;
                    document.getElementById('calories_kcal').value = data.calories_kcal;
                    document.getElementById('protein_g').value = data.protein_g;
                    document.getElementById('fat_g').value = data.fat_g;
                    document.getElementById('saturated_fat_g').value = data.saturated_fat_g;
                    document.getElementById('trans_fat_g').value = data.trans_fat_g;
                    document.getElementById('carbohydrate_g').value = data.carbohydrate_g;
                    document.getElementById('sugar_g').value = data.sugar_g;
                    document.getElementById('sodium_mg').value = data.sodium_mg;

                    newButton.disabled = false;
                    showLoadingState('save-btn', false); // 確保保存按鈕可用
                    showLoadingState('delete-btn', false); // 確保刪除按鈕可用
                    cancelButton.disabled = false;
                    document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                    document.querySelector(`.list-group-item[data-id="${ingredientId}"]`).classList.add('active');
                    setupFormEventListeners();
                    displayFormErrors({}); // 清除選擇新食材時的錯誤
                } else {
                    alert('獲取食材詳情失敗: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error fetching ingredient details:', error);
                alert('獲取食材詳情時發生錯誤。');
            });
    }


    function resetToInitialState() {
        formContainer.innerHTML = '<p class="alert alert-info text-center"><i>請從左側列表選擇一個食材來編輯，或點擊右側的「新增」按鈕。</i></p>';
        formTitle.textContent = '編輯食材資料';
        newButton.disabled = false;
        saveButton.disabled = true;
        deleteButton.disabled = true;
        cancelButton.disabled = true;
        currentIngredientId = null;
        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        displayFormErrors({}); // 清除錯誤
    }

    newButton.addEventListener('click', function() {
        formContainer.innerHTML = formTemplate;
        formTitle.textContent = '新增食材';
        currentIngredientId = 'new';
        newButton.disabled = true;
        showLoadingState('save-btn', false); // 確保保存按鈕可用
        deleteButton.disabled = true; // 新增狀態不能刪除
        cancelButton.disabled = false;
        document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
        setupFormEventListeners();
        displayFormErrors({}); // 清除錯誤
    });

    cancelButton.addEventListener('click', function() {
        resetToInitialState();
        performSearch(); // 取消後重新載入列表
    });

    saveButton.addEventListener('click', function() {
        const formData = getFormData();
        let url;
        if (currentIngredientId === 'new') {
            url = `/recipes/api/ingredient/create`;
        } else {
            url = `/recipes/api/ingredient/${currentIngredientId}/update`;
        }
        
        showLoadingState('save-btn', true); // 顯示載入狀態
        displayFormErrors({}); // 清除舊錯誤

        fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) })
        .then(response => response.json())
        .then(result => {
            alert(result.message);
            if (result.status === 'success') {
                performSearch();
                resetToInitialState();
            } else if (result.errors) {
                displayFormErrors(result.errors); // 顯示後端返回的驗證錯誤
            }
        })
        .catch(error => {
            console.error('Error saving ingredient:', error);
            alert('儲存食材時發生錯誤。');
        })
        .finally(() => {
            showLoadingState('save-btn', false); // 恢復按鈕狀態
        });
    });

    deleteButton.addEventListener('click', function() {
        if (currentIngredientId && currentIngredientId !== 'new' && confirm('您確定要永久刪除這個食材嗎？此操作無法恢復！')) {
            showLoadingState('delete-btn', true); // 顯示載入狀態

            fetch(`/recipes/api/ingredient/${currentIngredientId}/delete`, { method: 'POST' })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                if (result.status === 'success') {
                    performSearch();
                    resetToInitialState();
                }
            })
            .catch(error => {
                console.error('Error deleting ingredient:', error);
                alert('刪除食材時發生錯誤。');
            })
            .finally(() => {
                showLoadingState('delete-btn', false); // 恢復按鈕狀態
            });
        }
    });

    searchBox.addEventListener('keyup', performSearch);
    resetToInitialState(); // 初始狀態
    performSearch(); // 頁面載入時執行一次搜尋，顯示所有自訂食材
});
</script>
{% endblock %}