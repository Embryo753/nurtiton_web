{% extends "base.html" %}

{% block content %}
<style>
    .main-container { display: flex; flex-direction: row; gap: 20px; }
    #left-panel { width: 25%; border: 1px solid #ccc; padding: 10px; }
    #center-panel { width: 45%; border: 1px solid #ccc; padding: 10px; }
    #right-panel { width: 30%; border: 1px solid #ccc; padding: 10px; }
    #search-results .result-item { padding: 4px; cursor: pointer; border-bottom: 1px solid #eee; }
    #search-results .result-item:hover { background-color: #f0f0f0; }
    #search-results .result-item.active { background-color: #dbeafe; font-weight: bold; }
    .weight-input { width: 70px; text-align: right; }
    .remove-btn { cursor: pointer; color: red; font-weight: bold; }
    .action-btn { width: 100%; padding: 10px; margin-bottom: 10px; font-size: 16px; cursor: pointer; }
    .action-btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; }
    .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-form-input { width: 95%; margin-bottom: 5px; }
    .calculated-field { background-color: #eee; }
    .nutrition-table { border: 1px solid black; border-collapse: collapse; width: 100%; max-width: 400px; margin-top: 10px;}
    .nutrition-table th, .nutrition-table td { border: 1px solid black; padding: 4px 8px; text-align: left; }
    .nutrition-table thead { background-color: #f2f2f2; }
    .nutrition-table .nutrient-name-indent { padding-left: 20px; }
    .no-border-bottom { border-bottom: none !important; }
    .arrow-btn { cursor: pointer; color: blue; font-weight: bold; margin: 0 5px; user-select: none; }
</style>

<h1>食譜編輯器</h1>
<p><a href="{{ url_for('recipes.index') }}">&larr; 返回我的食譜列表</a></p>
<hr>

<div class="main-container">
    <div id="left-panel">
        <h3>搜尋食材</h3>
        <div>
            <label for="source-filter">種類:</label>
            <select id="source-filter"><option value="ALL" selected>全部產品</option><option value="TFDA">內建產品</option><option value="USER">自訂產品</option></select>
        </div>
        <div>
            <label for="ingredient-search-box">搜尋目標:</label>
            <input type="search" id="ingredient-search-box" style="width: 150px;" placeholder="請輸入關鍵字">
        </div>
        <hr>
        <h4>搜尋結果</h4>
        <div id="search-results" style="min-height: 300px; max-height: 400px; overflow-y: auto; border-top: 1px solid #eee;"></div>
    </div>
    <div id="center-panel">
        <h3>食譜名稱</h3>
        <p><input type="text" id="recipe-name-input" value="{{ recipe.recipe_name }}" style="width: 95%; font-size: 1.2em;"></p>
        <hr>
        <h3>產品內容</h3>
        <table border="1" cellpadding="5" id="ingredients-table" style="width:100%;">
            <thead><tr><th>名稱</th><th>重量(克)</th><th>操作</th></tr></thead>
            <tbody></tbody>
        </table>
        <div id="total-weight-display" style="text-align: right; font-weight: bold; padding-top: 10px;"></div>
        <div id="total-cost-display" style="text-align: right; font-weight: bold; padding-top: 5px;"></div> {# 新增此行以顯示總成本 #}
        <p id="no-ingredients-msg" style="display: none;">此食譜目前沒有任何食材。</p>
    </div>
    <div id="right-panel">
        <h3>產品設定</h3>
        <p>烘焙後總重: <input type="number" id="final-weight" placeholder="克" size="5" min="0"> 克</p>
        <p>產品份數: <input type="number" id="servings-count" size="5" min="1"> 份</p>
        <p>每份重量: <input type="number" id="serving-weight" readonly class="calculated-field" size="5" min="0"> 克</p>
        <hr>
        <h3>標示選項</h3>
        <div id="label-options-container">
            <strong>營養素顯示:</strong><br>
            <div style="columns: 2;">
            <label><input type="checkbox" class="label-option-nutrient" value="calories_kcal"> 熱量</label><br>
            <label><input type="checkbox" class="label-option-nutrient" value="protein_g"> 蛋白質</label><br>
            <label><input type="checkbox" class="label-option-nutrient" value="fat_g"> 脂肪</label><br>
            <label style="margin-left: 15px;"><input type="checkbox" class="label-option-nutrient" value="saturated_fat_g"> 飽和脂肪</label><br>
            <label style="margin-left: 15px;"><input type="checkbox" class="label-option-nutrient" value="trans_fat_g"> 反式脂肪</label><br>
            <label><input type="checkbox" class="label-option-nutrient" value="carbohydrate_g"> 碳水化合物</label><br>
            <label style="margin-left: 15px;"><input type="checkbox" class="label-option-nutrient" value="sugar_g"> 糖</label><br>
            <label><input type="checkbox" class="label-option-nutrient" value="sodium_mg"> 鈉</label><br>
            </div>
            <hr>
            <strong>過敏原資訊 (本產品含有...):</strong><br>
            <div style="columns: 2;">
                <label><input type="checkbox" class="allergen-option" value="甲殼類"> 甲殼類</label><br>
                <label><input type="checkbox" class="allergen-option" value="芒果"> 芒果</label><br>
                <label><input type="checkbox" class="allergen-option" value="花生"> 花生</label><br>
                <label><input type="checkbox" class="allergen-option" value="牛奶、羊奶"> 牛奶、羊奶</label><br>
                <label><input type="checkbox" class="allergen-option" value="蛋"> 蛋</label><br>
                <label><input type="checkbox" class="allergen-option" value="堅果類"> 堅果類</label><br>
                <label><input type="checkbox" class="allergen-option" value="芝麻"> 芝麻</label><br>
                <label><input type="checkbox" class="allergen-option" value="含麩質之穀物"> 含麩質之穀物</label><br>
                <label><input type="checkbox" class="allergen-option" value="大豆"> 大豆</label><br>
                <label><input type="checkbox" class="allergen-option" value="魚類"> 魚類</label><br>
                <label><input type="checkbox" class="allergen-option" value="亞硫酸鹽類"> 亞硫酸鹽類</label><br>
            </div>
        </div>
        <hr>
        <button id="save-recipe-btn" class="action-btn">儲存食譜</button>
        <a id="print-preview-btn" href="{{ url_for('recipes.recipe_label', recipe_id=recipe.id) }}" target="_blank" rel="noopener noreferrer">
            <button class="action-btn" style="background-color: #17a2b8; color: white;">預覽/列印標籤</button>
        </a>
    </div>
</div>
<hr>
<div id="nutrition-preview"></div>
<div id="add-ingredient-modal" class="modal">
    <div class="modal-content">
        <span id="close-modal-btn" class="close-btn">&times;</span>
        <h2 id="modal-title">新增自訂食材</h2>
        <div id="modal-form-container"></div>
        <button id="modal-save-btn" class="action-btn" style="background-color: #28a745; color: white;">儲存新食材</button>
    </div>
</div>

<script>
const initialState = {{ initial_state | tojson }};
document.addEventListener('DOMContentLoaded', function() {
    let recipeState = initialState;
    const recipeNameInput = document.getElementById('recipe-name-input');
    const servingWeightInput = document.getElementById('serving-weight');
    const servingsCountInput = document.getElementById('servings-count');
    const finalWeightInput = document.getElementById('final-weight');
    const searchBox = document.getElementById('ingredient-search-box');
    const sourceFilter = document.getElementById('source-filter');
    const searchResultsDiv = document.getElementById('search-results');
    const ingredientsTableBody = document.querySelector('#ingredients-table tbody');
    const noIngredientsMsg = document.getElementById('no-ingredients-msg');
    const saveButton = document.getElementById('save-recipe-btn');
    const printPreviewButton = document.getElementById('print-preview-btn');
    const totalWeightDiv = document.getElementById('total-weight-display');
    const totalCostDiv = document.getElementById('total-cost-display'); // 新增，用於顯示總成本
    const labelOptionsContainer = document.getElementById('label-options-container');
    const recipeId = {{ recipe.id }};
    const modal = document.getElementById('add-ingredient-modal');
    const modalFormContainer = document.getElementById('modal-form-container');
    const modalSaveButton = document.getElementById('modal-save-btn');
    const closeModalButton = document.getElementById('close-modal-btn');
    const formTemplate = `<p>食材名稱:<br><input type="text" id="modal_food_name" class="modal-form-input" required></p><p>成本 (每100g):<br><input type="number" id="modal_cost_per_unit" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>單位名稱:<br><input type="text" id="modal_unit_name" class="modal-form-input" value="g" required></p><p>熱量 (大卡/100g):<br><input type="number" id="modal_calories_kcal" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>蛋白質 (克/100g):<br><input type="number" id="modal_protein_g" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>總脂肪 (克/100g):<br><input type="number" id="modal_fat_g" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>飽和脂肪 (克/100g):<br><input type="number" id="modal_saturated_fat_g" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>反式脂肪 (克/100g):<br><input type="number" id="modal_trans_fat_g" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>總碳水化合物 (克/100g):<br><input type="number" id="modal_carbohydrate_g" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>糖 (克/100g):<br><input type="number" id="modal_sugar_g" class="modal-form-input" value="0" required min="0" step="0.01"></p><p>鈉 (毫克/100g):<br><input type="number" id="modal_sodium_mg" class="modal-form-input" value="0" required min="0" step="0.1"></p>`;


    function setupInputEventListeners(containerElement) {
        const inputs = containerElement.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            if (input.dataset.eventsAttached) return;
            input.addEventListener('focus', function() { if (this.value === '0' || this.value === '0.0') { this.value = ''; } });
            input.addEventListener('blur', function() { if (this.value === '') { this.value = '0'; } });
            input.dataset.eventsAttached = true;
        });
    }

    function renderTable() {
        ingredientsTableBody.innerHTML = '';
        noIngredientsMsg.style.display = recipeState.ingredients.length > 0 ? 'none' : 'block';
        recipeState.ingredients.forEach(item => {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-ingredient-id', item.ingredient_id);
            newRow.innerHTML = `<td>${item.ingredient_name}</td><td><input type="number" class="weight-input" value="${item.quantity_g}" min="0" step="0.1" data-ingredient-id="${item.ingredient_id}"></td><td><span class="arrow-btn up-btn" title="上移">↑</span><span class="arrow-btn down-btn" title="下移">↓</span><span class="remove-btn" data-ingredient-id="${item.ingredient_id}">移除</span></td>`;
            ingredientsTableBody.appendChild(newRow);
        });
        setupInputEventListeners(ingredientsTableBody);
    }

    function calculateAndDisplayNutrition() {
        const previewDiv = document.getElementById('nutrition-preview');
        let rawTotals = {
            calories_kcal: 0, protein_g: 0, fat_g: 0, carbohydrate_g: 0,
            saturated_fat_g: 0, trans_fat_g: 0, sugar_g: 0, sodium_mg: 0,
            total_weight_g: 0, total_cost: 0 // 新增 total_cost
        };
        recipeState.ingredients.forEach(item => {
            const quantity = parseFloat(item.quantity_g) || 0;
            if (quantity <= 0 || !item.details) return;
            const scale = quantity / 100.0;
            rawTotals.calories_kcal += (item.details.calories_kcal || 0) * scale;
            rawTotals.protein_g += (item.details.protein_g || 0) * scale;
            rawTotals.fat_g += (item.details.fat_g || 0) * scale;
            rawTotals.carbohydrate_g += (item.details.carbohydrate_g || 0) * scale;
            rawTotals.saturated_fat_g += (item.details.saturated_fat_g || 0) * scale;
            rawTotals.trans_fat_g += (item.details.trans_fat_g || 0) * scale;
            rawTotals.sugar_g += (item.details.sugar_g || 0) * scale;
            rawTotals.sodium_mg += (item.details.sodium_mg || 0) * scale;
            rawTotals.total_weight_g += quantity;
            // 計算成本： 食譜項目重量(g) / 100g * 每100g成本
            rawTotals.total_cost += ((item.details.cost_per_unit || 0) / 100.0) * quantity; // 新增成本計算
        });

        totalWeightDiv.innerHTML = `<strong>原料總重: ${rawTotals.total_weight_g.toFixed(1)} 公克</strong>`;
        totalCostDiv.innerHTML = `<strong>食譜總成本: NT$ ${rawTotals.total_cost.toFixed(2)}</strong>`; // 顯示食譜總成本

        const finalWeight = parseFloat(finalWeightInput.value) || rawTotals.total_weight_g;
        const servingsCount = parseInt(servingsCountInput.value) || 1;
        const servingWeight = (finalWeight > 0 && servingsCount > 0) ? (finalWeight / servingsCount) : 0;
        if (finalWeight <= 0) {
            previewDiv.innerHTML = '<h2>營養標示 (預覽)</h2><p>請先加入食材或設定烘焙後總重以計算營養成分。</p>';
            if(printPreviewButton) printPreviewButton.style.display = 'none';
            return;
        }
        if(printPreviewButton) printPreviewButton.style.display = 'block';
        const density = {};
        for (const key in rawTotals) {
            if (key !== 'total_cost' && finalWeight > 0) { // 成本不是密度，不參與這裡的密度計算
                density[key] = rawTotals[key] / finalWeight;
            } else if (key !== 'total_cost') {
                density[key] = 0;
            }
        }
        const perServing = {};
        const per100g = {};
        for (const key in density) {
            perServing[key] = density[key] * servingWeight;
            per100g[key] = density[key] * 100;
        }

        // --- 根據勾選的選項來動態生成營養標示表格 ---
        const showNutrients = recipeState.label_options.show_nutrients || {};
        let nutritionTableHtml = `
            <h2 style="text-align:center;">營養標示</h2>
            <table class="nutrition-table">
                <thead>
                    <tr><td colspan="3" style="text-align: left;">每一份量 ${servingWeight.toFixed(1)} 公克</td></tr>
                    <tr><td colspan="3" style="text-align: left; border-bottom: 2px solid black;">本包裝含 ${servingsCount} 份</td></tr>
                    <tr class="header-row"><th></th><th style="text-align:right;">每份</th><th style="text-align:right;">每100公克</th></tr>
                </thead>
                <tbody>
        `;

        const nutrientOrder = [
            'calories_kcal', 'protein_g', 'fat_g', 'saturated_fat_g', 'trans_fat_g',
            'carbohydrate_g', 'sugar_g', 'sodium_mg'
        ];
        const nutrientNames = {
            'calories_kcal': '熱量',
            'protein_g': '蛋白質',
            'fat_g': '脂肪',
            'saturated_fat_g': '飽和脂肪',
            'trans_fat_g': '反式脂肪',
            'carbohydrate_g': '碳水化合物',
            'sugar_g': '糖',
            'sodium_mg': '鈉'
        };
        const indentNutrients = ['saturated_fat_g', 'trans_fat_g', 'sugar_g'];

        nutrientOrder.forEach((key, index) => {
            if (showNutrients[key] !== false) { // 預設為 True，只有明確設定為 false 才不顯示
                const isIndented = indentNutrients.includes(key) ? 'nutrient-name-indent' : '';
                const noBorderBottom = (index === nutrientOrder.length - 1) ? 'no-border-bottom' : '';
                const unit = (key === 'calories_kcal') ? '大卡' : (key === 'sodium_mg' ? '毫克' : '公克');
                const fixed = (key === 'sodium_mg') ? 0 : 1; // 鈉保留0位小數，其他1位

                nutritionTableHtml += `
                    <tr class="${noBorderBottom}">
                        <th class="${isIndented}">${nutrientNames[key]}</th>
                        <td style="text-align:right;">${perServing[key].toFixed(fixed)} ${unit}</td>
                        <td style="text-align:right;">${per100g[key].toFixed(fixed)} ${unit}</td>
                    </tr>
                `;
            }
        });

        nutritionTableHtml += `</tbody></table>`;
        previewDiv.innerHTML = nutritionTableHtml;
        // --- 結束動態生成營養標示表格 ---
    }
    
    function calculateServingWeight() {
        const finalWeight = parseFloat(finalWeightInput.value) || 0;
        const servingsCount = parseInt(servingsCountInput.value) || 1;
        servingWeightInput.value = (finalWeight > 0 && servingsCount > 0) ? (finalWeight / servingsCount).toFixed(1) : '0.0';
    }

    function updateAll() { renderTable(); calculateAndDisplayNutrition(); }

    function addIngredientToState(ingredientData) {
        if (recipeState.ingredients.some(item => item.ingredient_id == ingredientData.id)) { alert('這個食材已經在列表中了！'); return; }
        // 確保將 cost_per_unit 和 unit_name 加入到 details 中
        recipeState.ingredients.push({
            ingredient_id: ingredientData.id,
            ingredient_name: ingredientData.name,
            quantity_g: 0,
            details: {
                calories_kcal: ingredientData.calories_kcal, protein_g: ingredientData.protein_g,
                fat_g: ingredientData.fat_g, saturated_fat_g: ingredientData.saturated_fat_g,
                trans_fat_g: ingredientData.trans_fat_g, carbohydrate_g: ingredientData.carbohydrate_g,
                sugar_g: ingredientData.sugar_g, sodium_mg: ingredientData.sodium_mg,
                cost_per_unit: ingredientData.cost_per_unit, // 新增
                unit_name: ingredientData.unit_name // 新增
            }
        });
        updateAll();
    }
    
    function updateStateOrder() {
        const newOrder = [];
        const rows = ingredientsTableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const ingredientId = parseInt(row.getAttribute('data-ingredient-id'));
            const item = recipeState.ingredients.find(i => i.ingredient_id === ingredientId);
            if (item) {
                const newQuantity = parseFloat(row.querySelector('.weight-input').value) || 0;
                item.quantity_g = newQuantity;
                newOrder.push(item);
            }
        });
        recipeState.ingredients = newOrder;
        calculateAndDisplayNutrition();
    }

    function performSearch() {
        const query = searchBox.value.trim();
        const source = sourceFilter.value;
        if (!query && source === 'ALL') { searchResultsDiv.innerHTML = ''; return; }
        fetch(`/recipes/api/search_ingredients?q=${query}&source=${source}`).then(response => response.json()).then(data => {
            searchResultsDiv.innerHTML = '';
            if (data.length > 0) {
                data.forEach(ingredient => { const resultItem = document.createElement('div'); resultItem.textContent = ingredient.name; resultItem.className = 'result-item'; resultItem.addEventListener('click', () => addIngredientToState(ingredient)); searchResultsDiv.appendChild(resultItem); });
            } else if (query) {
                const createBtn = document.createElement('button'); createBtn.textContent = `+ 新增「${query}」為自訂食材`; createBtn.className = 'action-btn'; createBtn.style.cssText = 'width:auto; background-color:#007bff; color:white;'; createBtn.addEventListener('click', () => openAddModal(query)); searchResultsDiv.appendChild(createBtn);
            }
        });
    }

    function openAddModal(prefilledName) {
        modalFormContainer.innerHTML = formTemplate;
        document.getElementById('modal_food_name').value = prefilledName;
        modal.style.display = 'block';
        setupInputEventListeners(modalFormContainer);
    }

    function closeModal() { modal.style.display = 'none'; }
    
    function initializePage() {
        servingWeightInput.value = recipeState.serving_weight_g;
        servingsCountInput.value = recipeState.servings_count;
        finalWeightInput.value = recipeState.final_weight_g || '';
        if (recipeState.label_options) {
            const savedNutrients = recipeState.label_options.show_nutrients || {};
            const savedAllergens = recipeState.label_options.allergens || [];
            labelOptionsContainer.querySelectorAll('.label-option-nutrient').forEach(checkbox => { checkbox.checked = savedNutrients[checkbox.value] !== false; });
            labelOptionsContainer.querySelectorAll('.allergen-option').forEach(checkbox => { checkbox.checked = savedAllergens.includes(checkbox.value); });
        } else {
             labelOptionsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => { checkbox.checked = true; });
        }
        updateAll();
        performSearch();
        calculateServingWeight();
    }
    
    ingredientsTableBody.addEventListener('input', function(event) { if (event.target.classList.contains('weight-input')) { const ingredientIdToUpdate = parseInt(event.target.getAttribute('data-ingredient-id')); const newQuantity = parseFloat(event.target.value) || 0; const item = recipeState.ingredients.find(i => i.ingredient_id == ingredientIdToUpdate); if(item) { item.quantity_g = newQuantity; } calculateAndDisplayNutrition(); } });
    ingredientsTableBody.addEventListener('click', function(event) {
        const target = event.target;
        const row = target.closest('tr');
        if (!row) return;
        if (target.classList.contains('remove-btn')) {
            const ingredientIdToRemove = parseInt(target.getAttribute('data-ingredient-id'));
            if (confirm(`您確定要移除嗎？`)) { recipeState.ingredients = recipeState.ingredients.filter(item => item.ingredient_id != ingredientIdToRemove); updateAll(); }
        } else if (target.classList.contains('up-btn')) {
            const prevRow = row.previousElementSibling;
            if (prevRow) { ingredientsTableBody.insertBefore(row, prevRow); updateStateOrder(); }
        } else if (target.classList.contains('down-btn')) {
            const nextRow = row.nextElementSibling;
            if (nextRow) { ingredientsTableBody.insertBefore(nextRow, row); updateStateOrder(); }
        }
    });

    // 預覽/列印標籤按鈕的點擊事件
    printPreviewButton.addEventListener('click', function(event) {
        event.preventDefault(); // 阻止默認的跳轉行為
        updateStateFromUI(); // 確保 recipeState 包含最新的數據

        // 呼叫後端新的 API 來獲取預覽文字
        fetch(`/recipes/api/recipe/preview_label`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(recipeState) // 發送當前的 recipeState
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 將獲取到的預覽文字填充到一個隱藏表單中
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = this.href; // 使用原始連結的 href 作為 action
                form.target = '_blank'; // 在新視窗打開

                for (const key in data) {
                    if (key !== 'status') { // 排除 status 欄位
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = data[key];
                        form.appendChild(input);
                    }
                }
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form); // 提交後移除表單
            } else {
                alert('預覽標籤失敗: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching preview data:', error);
            alert('預覽標籤時發生錯誤，請檢查控制台。');
        });
    });

    saveButton.addEventListener('click', function() {
        updateStateFromUI(); // <-- Call the unified update function
        fetch(`/recipes/api/recipe/${recipeId}/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(recipeState) }).then(response => response.json()).then(data => { if (data.status === 'success') { alert(data.message); window.location.reload(); } else { alert('儲存失敗: ' + data.message); } });
    });

    function updateStateFromUI() {
        recipeState.recipe_name = recipeNameInput.value;
        recipeState.serving_weight_g = parseFloat(servingWeightInput.value) || 100; // 確保是數字
        recipeState.servings_count = parseInt(servingsCountInput.value) || 1; // 確保是整數
        recipeState.final_weight_g = parseFloat(finalWeightInput.value) || null; // 確保是數字或 null
        
        const showNutrients = {};
        labelOptionsContainer.querySelectorAll('.label-option-nutrient').forEach(checkbox => { showNutrients[checkbox.value] = checkbox.checked; });
        const allergens = [];
        labelOptionsContainer.querySelectorAll('.allergen-option:checked').forEach(checkbox => { allergens.push(checkbox.value); });
        recipeState.label_options = { show_nutrients: showNutrients, allergens: allergens };

        const itemsInTable = [];
        const rows = ingredientsTableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const id = parseInt(row.getAttribute('data-ingredient-id'));
            const originalItem = recipeState.ingredients.find(i => i.ingredient_id === id);
            if (originalItem) {
                originalItem.quantity_g = parseFloat(row.querySelector('.weight-input').value) || 0;
                itemsInTable.push(originalItem);
            }
        });
        recipeState.ingredients = itemsInTable;
    }

    modalSaveButton.addEventListener('click', function() {
        const formData = {
            food_name: document.getElementById('modal_food_name').value,
            cost_per_unit: document.getElementById('modal_cost_per_unit').value, // 新增
            unit_name: document.getElementById('modal_unit_name').value, // 新增
            calories_kcal: document.getElementById('modal_calories_kcal').value,
            protein_g: document.getElementById('modal_protein_g').value, fat_g: document.getElementById('modal_fat_g').value,
            saturated_fat_g: document.getElementById('modal_saturated_fat_g').value, trans_fat_g: document.getElementById('modal_trans_fat_g').value,
            carbohydrate_g: document.getElementById('modal_carbohydrate_g').value, sugar_g: document.getElementById('modal_sugar_g').value,
            sodium_mg: document.getElementById('modal_sodium_mg').value,
        };
        fetch('/recipes/api/ingredient/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) })
        .then(response => response.json()).then(result => {
            if (result.status === 'success') {
                alert(`「${result.ingredient.name}」已成功新增！`);
                closeModal();
                const newIngredientData = {
                    id: result.ingredient.id, name: result.ingredient.name,
                    calories_kcal: parseFloat(formData.calories_kcal), protein_g: parseFloat(formData.protein_g),
                    fat_g: parseFloat(formData.fat_g), saturated_fat_g: parseFloat(formData.saturated_fat_g),
                    trans_fat_g: parseFloat(formData.trans_fat_g), carbohydrate_g: parseFloat(formData.carbohydrate_g),
                    sugar_g: parseFloat(formData.sugar_g), sodium_mg: parseFloat(formData.sodium_mg),
                    cost_per_unit: parseFloat(formData.cost_per_unit), // 新增
                    unit_name: formData.unit_name // 新增
                };
                addIngredientToState(newIngredientData);
                searchBox.value = ''; searchResultsDiv.innerHTML = '';
            } else { alert(`新增失敗: ${result.message}`); }
        });
    });

    closeModalButton.addEventListener('click', closeModal);
    window.onclick = function(event) { if (event.target == modal) { closeModal(); } }
    searchBox.addEventListener('keyup', function(e){ setTimeout(() => performSearch(), 300) });
    sourceFilter.addEventListener('change', performSearch);
    finalWeightInput.addEventListener('input', () => { calculateServingWeight(); calculateAndDisplayNutrition(); });
    servingsCountInput.addEventListener('input', () => { calculateServingWeight(); calculateAndDisplayNutrition(); });
    
    // 監聽營養素顯示選項的變化，並即時更新預覽
    labelOptionsContainer.querySelectorAll('.label-option-nutrient').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const nutrientName = checkbox.value;
            recipeState.label_options = recipeState.label_options || {};
            recipeState.label_options.show_nutrients = recipeState.label_options.show_nutrients || {};
            recipeState.label_options.show_nutrients[nutrientName] = checkbox.checked;
            calculateAndDisplayNutrition(); // 重新計算並顯示
        });
    });

    // 監聽過敏原選項的變化，並即時更新預覽
    labelOptionsContainer.querySelectorAll('.allergen-option').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const allergenName = checkbox.value;
            recipeState.label_options = recipeState.label_options || {};
            recipeState.label_options.allergens = recipeState.label_options.allergens || [];
            if (checkbox.checked) {
                if (!recipeState.label_options.allergens.includes(allergenName)) {
                    recipeState.label_options.allergens.push(allergenName);
                }
            } else {
                recipeState.label_options.allergens = recipeState.label_options.allergens.filter(a => a !== allergenName);
            }
            // 過敏原資訊不影響營養標示表格，這裡不需要重新計算營養標示
            // 如果要在預覽中顯示過敏原文字，需要在 calculateAndDisplayNutrition 中處理
        });
    });

    initializePage();
});
</script>
{% endblock %}